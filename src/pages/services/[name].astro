---
import Layout from "../../layouts/Layout.astro";
import { client } from "../../../.tina/__generated__/client.js"
import { marked } from "marked";
import { Debug } from 'astro:components'
import { TinaMarkdown } from 'tinacms/dist/rich-text'
import { ServiceRelations, ServiceLinks, ServiceInvolved_Parties, Service } from "../../../.tina/__generated__/types";

export async function getStaticPaths() {
  const serviceResponse = await client.queries.serviceConnection()
  return serviceResponse.data.serviceConnection.edges?.map((service) => ({
    params: {
      name: service?.node?.name
    },
    props: { service: service?.node },
  }))
}


const service: Service = Astro.props.service
const relations = service!.relations?.map((relation: ServiceRelations) => {
  return {
    description: relation!.description,
    name: relation!.service.name,
    relation_criticality: relation!.relation_criticality
  }
})
---

<Layout title={service.name}>
  <main class="container mx-auto py-10">
    <article class="bg-white shadow-md rounded-xl p-10 max-w-4xl mx-auto">
      <h1 class="text-5xl font-extrabold">{service.name}</h1>
      <span class="block text-sm mb-3"
        >Leztes Update dieser Daten: {
          new Date(service.last_update).toLocaleDateString("de-CH", {
            year: "numeric",
            month: "long",
            day: "numeric",
          })
        }</span
      >
      <TinaMarkdown content={service.description}/>
      <dl class="mb-4 mt-3">
        <dt class="font-bold">Criticality</dt>
        <dd>
          {service.criticality}
        </dd>
      </dl>
      <dl class="mb-4 mt-3">
        <dt class="font-bold">Product Owner</dt>
        <dd>
          {service.product_owner?.name}
        </dd>
      </dl>
      <dl class="mb-4 mt-3">
        <dt class="font-bold">Development</dt>
        <dd>
          {service.development}
        </dd>
      </dl>
      <dl class="mb-4 mt-3">
        <dt class="font-bold">Operations</dt>
        <dd>
          {service.operations}
        </dd>
      </dl>
      <dl class="mb-4 mt-3">
        <dt class="font-bold">SLA</dt>
        <dd>
          {service.has_sla}
        </dd>
      </dl>
      <dl class="mb-4 mt-3">
        <dt class="font-bold">Links</dt>
        <dd>
          <ul class="list-disc ps-5">
            {
              service.links?.map((link: ServiceLinks) => (
                <li>
                  <a class="text-brombeer hover:underline" href={link.url}>
                    {link.label}
                  </a>
                </li>
              ))
            }
          </ul>
        </dd>
      </dl>

      <dl class="mb-4 mt-3">
        <dt class="font-bold">Steckbrief</dt>
        <dd>
          <TinaMarkdown content={service.strategy_reference}/>
        </dd>
      </dl>

      <dl class="mb-4 mt-3">
        <dt class="font-bold">Abh√§ngigkeiten</dt>
        <dd>
          <ul class="list-disc ps-5">
            {
              relations?.map((relation) => {
                return (
                  <li>
                    {relation.description}:{" "}
                    <a class="text-brombeer hover:underline" href={`/it-landscape/services/${relation.name}`}>
                      {relation.name}{" "}
                    </a>
                    <span class="bg-red-100 text-red-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded">
                      {relation.relation_criticality}
                    </span>
                  </li>
                );
              })
            }
          </ul>
        </dd>
      </dl>

      <dl class="mb-4 mt-3">
        <dt class="font-bold">Involvierte Parteien</dt>
        <dd>
          <ul class="list-disc ps-5">
            {
              service.involved_parties?.map((involvedParty: ServiceInvolved_Parties) => {
                return (
                  <li>
                    {involvedParty.description}:{" "}
                    <a class="text-brombeer hover:underline" href={`/it-landscape/parties/${involvedParty.party.name}`}>
                      {involvedParty.party.name}
                    </a>
                  </li>
                );
              })
            }
          </ul>
        </dd>
      </dl>
    </article>
  </main>
</Layout>
